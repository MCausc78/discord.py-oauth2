name: Rename

on:
  workflow_dispatch:
  push:
    branches: [ master ]

# Runs do not need to be concurrent
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
  rename:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Replace instances
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'

          git checkout master
          git checkout -b temp master
          rm -rf docs .github .readthedocs.yml tests
          mv discord oauth2cord

          sed -i -e 's/import discord/import oauth2cord/g' -e '/from discord_protos/!{s/from discord/from oauth2cord/g}' -e '/from discord_protos/!{s/from discord/from oauth2cord/g}' -e 's/discord\.py/oauth2cord\.py/g' -e '/\(discord\.com\|discord\.gift\|discord\.gg\|discord\.new\)/! s/discord\./oauth2cord\./g' $(find oauth2cord examples -name "*.py")
          sed -i -e 's/discord/oauth2cord/g' MANIFEST.in setup.py
          sed -i -E 's/^name = "discord\.py"/name = "oauth2cord.py"/; /http/!s/\bdiscord\b/oauth2cord/g' pyproject.toml

      - name: Push changes
        run: |
          git add .
          git stash
          git switch renamed
          git checkout stash -- .

          (git commit -am "Synchronize oauth2cord") || true
          (git push origin renamed) || true